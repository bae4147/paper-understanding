<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiment Admin Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Icon components
        const UploadIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        );
 
        const DownloadIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const FileIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
            </svg>
        );

        const TrashIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        );

        function AdminDashboard() {
            const [experiments, setExperiments] = useState([]);
            const [selectedExperiment, setSelectedExperiment] = useState(null);
            const [view, setView] = useState('list'); // 'list', 'detail', 'compare'
            const [compareExperiments, setCompareExperiments] = useState([]);
            const chartRefs = useRef({});

            // Load experiments from localStorage on mount
            useEffect(() => {
                loadExperiments();
            }, []);

            const loadExperiments = () => {
                const stored = localStorage.getItem('experimentEvents');
                if (stored) {
                    try {
                        const events = JSON.parse(stored);
                        // Group events by sessionId
                        const groupedBySession = {};
                        events.forEach(event => {
                            if (!groupedBySession[event.sessionId]) {
                                groupedBySession[event.sessionId] = {
                                    sessionId: event.sessionId,
                                    participantId: event.participantId,
                                    condition: event.condition,
                                    paper: event.paper,
                                    events: []
                                };
                            }
                            groupedBySession[event.sessionId].events.push(event);
                        });
                        
                        const experimentsList = Object.values(groupedBySession).map(exp => ({
                            ...exp,
                            startTime: exp.events[0]?.timestamp,
                            endTime: exp.events[exp.events.length - 1]?.timestamp,
                            duration: exp.events.length > 0 ? 
                                exp.events[exp.events.length - 1].timestamp - exp.events[0].timestamp : 0
                        }));
                        
                        setExperiments(experimentsList);
                    } catch (error) {
                        console.error('Error loading experiments:', error);
                    }
                }
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            setExperiments(prev => [...prev, data]);
                            alert('Experiment data loaded successfully!');
                        } catch (error) {
                            alert('Error parsing JSON file');
                            console.error(error);
                        }
                    };
                    reader.readAsText(file);
                }
            };

            const calculateStats = (exp) => {
                if (!exp || !exp.events) return null;

                const events = exp.events;
                
                // Filter only scroll_pause events for reading/scanning/scrolling stats
                const scrollEvents = events.filter(e => e.eventType === 'scroll_pause');
                const reading = scrollEvents.filter(e => e.classification === 'reading').length;
                const scanning = scrollEvents.filter(e => e.classification === 'scanning').length;
                const scrolling = scrollEvents.filter(e => e.classification === 'scrolling').length;
                
                const llmQueries = events.filter(e => e.eventType === 'llm_query').length;
                const searches = events.filter(e => e.eventType === 'search').length;
                const highlights = events.filter(e => e.eventType === 'highlight').length;

                // Calculate time spent in each section (pause + scroll)
                const sectionTimes = {};
                scrollEvents.forEach(event => {
                    if (event.currentSection) {
                        if (!sectionTimes[event.currentSection]) {
                            sectionTimes[event.currentSection] = 0;
                        }
                        const eventTotalTime = (event.pauseDuration || 0) + (event.scrollDuration || 0);
                        sectionTimes[event.currentSection] += eventTotalTime;
                    }
                });

                // NEW LOGIC: Separate pause and scroll
                // Reading/Scanning time = ONLY pause time
                // Scrolling time = ALL scroll motion time
                
                const readingPauseTime = scrollEvents.filter(e => e.classification === 'reading')
                    .reduce((sum, e) => sum + (e.pauseDuration || 0), 0);
                const scanningPauseTime = scrollEvents.filter(e => e.classification === 'scanning')
                    .reduce((sum, e) => sum + (e.pauseDuration || 0), 0);
                const scrollingPauseTime = scrollEvents.filter(e => e.classification === 'scrolling')
                    .reduce((sum, e) => sum + (e.pauseDuration || 0), 0);
                
                // ALL scroll motion goes to "Scrolling"
                const allScrollTime = scrollEvents.reduce((sum, e) => sum + (e.scrollDuration || 0), 0);

                // Total reading time = all pauses + all scrolls
                const totalReadingTime = readingPauseTime + scanningPauseTime + scrollingPauseTime + allScrollTime;

                return {
                    totalEvents: events.length,
                    scrollPauseEvents: scrollEvents.length,
                    reading,
                    scanning,
                    scrolling,
                    llmQueries,
                    searches,
                    highlights,
                    readingPercentage: scrollEvents.length > 0 ? ((reading / scrollEvents.length) * 100).toFixed(1) : 0,
                    scanningPercentage: scrollEvents.length > 0 ? ((scanning / scrollEvents.length) * 100).toFixed(1) : 0,
                    scrollingPercentage: scrollEvents.length > 0 ? ((scrolling / scrollEvents.length) * 100).toFixed(1) : 0,
                    totalReadingTime: (totalReadingTime / 1000).toFixed(1), // in seconds
                    readingTime: (readingPauseTime / 1000).toFixed(1),  // ONLY pause
                    scanningTime: (scanningPauseTime / 1000).toFixed(1), // ONLY pause
                    scrollingTime: (allScrollTime / 1000).toFixed(1),     // ALL scroll motion
                    scrollingPauseTime: (scrollingPauseTime / 1000).toFixed(1), // For reference
                    readingTimePercentage: totalReadingTime > 0 ? ((readingPauseTime / totalReadingTime) * 100).toFixed(1) : 0,
                    scanningTimePercentage: totalReadingTime > 0 ? ((scanningPauseTime / totalReadingTime) * 100).toFixed(1) : 0,
                    scrollingTimePercentage: totalReadingTime > 0 ? ((allScrollTime / totalReadingTime) * 100).toFixed(1) : 0,
                    sectionTimes,
                    averageEventInterval: events.length > 1 ? 
                        (exp.duration / events.length / 1000).toFixed(2) : 0
                };
            };

            const exportCSV = (exp) => {
                if (!exp) return;

                const headers = [
                    'Timestamp', 'Event Type', 'Classification', 'Page Number',
                    'Scroll Position', 'Current Section', 'Time Since Last (ms)'
                ];

                const rows = exp.events.map(event => [
                    new Date(event.timestamp).toISOString(),
                    event.eventType,
                    event.classification,
                    event.pageNumber,
                    event.scrollPosition,
                    event.currentSection,
                    event.timeSinceLast
                ]);

                const csv = [
                    headers.join(','),
                    ...rows.map(row => row.join(','))
                ].join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `experiment_${exp.participantId}_${exp.sessionId}.csv`;
                link.click();
            };

            const deleteExperiment = (sessionId) => {
                if (confirm('Are you sure you want to delete this experiment?')) {
                    setExperiments(prev => prev.filter(exp => exp.sessionId !== sessionId));
                    if (selectedExperiment?.sessionId === sessionId) {
                        setSelectedExperiment(null);
                        setView('list');
                    }
                }
            };

            const clearAllData = () => {
                if (confirm('Are you sure you want to clear ALL experiment data? This cannot be undone.')) {
                    localStorage.removeItem('experimentEvents');
                    setExperiments([]);
                    setSelectedExperiment(null);
                    setView('list');
                    alert('All data cleared');
                }
            };

            // Chart rendering effect
            useEffect(() => {
                if (view !== 'detail' || !selectedExperiment) return;

                const stats = calculateStats(selectedExperiment);
                if (!stats) return;

                // Destroy existing charts
                Object.values(chartRefs.current).forEach(chart => {
                    if (chart) chart.destroy();
                });
                chartRefs.current = {};

                // Classification chart
                const classificationCtx = document.getElementById('classificationChart');
                if (classificationCtx) {
                    chartRefs.current.classification = new Chart(classificationCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Reading (>5s)', 'Scanning (2-5s)', 'Scrolling (<2s)'],
                            datasets: [{
                                data: [stats.reading, stats.scanning, stats.scrolling],
                                backgroundColor: ['#3B82F6', '#10B981', '#F59E0B'],
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                }

                // Section time chart
                const sectionCtx = document.getElementById('sectionTimeChart');
                if (sectionCtx) {
                    chartRefs.current.section = new Chart(sectionCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(stats.sectionTimes),
                            datasets: [{
                                label: 'Time (seconds)',
                                data: Object.values(stats.sectionTimes).map(t => (t / 1000).toFixed(1)),
                                backgroundColor: '#3B82F6',
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Time (seconds)'
                                    }
                                }
                            }
                        }
                    });
                }

                return () => {
                    Object.values(chartRefs.current).forEach(chart => {
                        if (chart) chart.destroy();
                    });
                };
            }, [view, selectedExperiment]);

            // List view
            if (view === 'list') {
                return (
                    <div className="min-h-screen bg-gray-50">
                        {/* Header */}
                        <div className="bg-white shadow-md">
                            <div className="max-w-7xl mx-auto px-6 py-6">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h1 className="text-3xl font-bold text-gray-900">Experiment Dashboard</h1>
                                        <p className="text-gray-600 mt-1">PDF Reading Study - Admin Panel</p>
                                    </div>
                                    <div className="flex items-center space-x-3">
                                        <label className="flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer transition-colors">
                                            <UploadIcon />
                                            <span>Upload JSON</span>
                                            <input
                                                type="file"
                                                accept=".json"
                                                onChange={handleFileUpload}
                                                className="hidden"
                                            />
                                        </label>
                                        <button
                                            onClick={clearAllData}
                                            className="flex items-center space-x-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                                        >
                                            <TrashIcon />
                                            <span>Clear All</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Stats Overview */}
                        <div className="max-w-7xl mx-auto px-6 py-6">
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                <div className="bg-white rounded-lg shadow-md p-6">
                                    <p className="text-gray-600 text-sm">Total Experiments</p>
                                    <p className="text-3xl font-bold text-blue-600">{experiments.length}</p>
                                </div>
                                <div className="bg-white rounded-lg shadow-md p-6">
                                    <p className="text-gray-600 text-sm">With LLM</p>
                                    <p className="text-3xl font-bold text-green-600">
                                        {experiments.filter(e => e.condition === 'with_llm').length}
                                    </p>
                                </div>
                                <div className="bg-white rounded-lg shadow-md p-6">
                                    <p className="text-gray-600 text-sm">Without LLM</p>
                                    <p className="text-3xl font-bold text-orange-600">
                                        {experiments.filter(e => e.condition === 'without_llm').length}
                                    </p>
                                </div>
                                <div className="bg-white rounded-lg shadow-md p-6">
                                    <p className="text-gray-600 text-sm">Unique Participants</p>
                                    <p className="text-3xl font-bold text-purple-600">
                                        {new Set(experiments.map(e => e.participantId)).size}
                                    </p>
                                </div>
                            </div>

                            {/* Experiments Table */}
                            <div className="bg-white rounded-lg shadow-md overflow-hidden">
                                <div className="px-6 py-4 bg-gray-50 border-b">
                                    <h2 className="text-xl font-bold text-gray-900">Experiments</h2>
                                </div>
                                
                                {experiments.length === 0 ? (
                                    <div className="text-center py-12">
                                        <FileIcon />
                                        <p className="text-gray-600 mt-4">No experiments yet</p>
                                        <p className="text-sm text-gray-500 mt-2">
                                            Upload a JSON file or run the experiment to collect data
                                        </p>
                                    </div>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        Participant
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        Condition
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        Paper
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        Events
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        Duration
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        Date
                                                    </th>
                                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                                                        Actions
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-200">
                                                {experiments.map((exp, idx) => {
                                                    const stats = calculateStats(exp);
                                                    return (
                                                        <tr key={idx} className="hover:bg-gray-50">
                                                            <td className="px-6 py-4 whitespace-nowrap">
                                                                <span className="font-medium text-gray-900">
                                                                    {exp.participantId}
                                                                </span>
                                                            </td>
                                                            <td className="px-6 py-4 whitespace-nowrap">
                                                                <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                                                                    exp.condition === 'with_llm' 
                                                                        ? 'bg-green-100 text-green-800' 
                                                                        : 'bg-orange-100 text-orange-800'
                                                                }`}>
                                                                    {exp.condition === 'with_llm' ? 'With LLM' : 'Without LLM'}
                                                                </span>
                                                            </td>
                                                            <td className="px-6 py-4 text-sm text-gray-600">
                                                                {exp.paper || 'N/A'}
                                                            </td>
                                                            <td className="px-6 py-4 text-sm text-gray-900">
                                                                {stats?.totalEvents || 0}
                                                            </td>
                                                            <td className="px-6 py-4 text-sm text-gray-600">
                                                                {Math.floor((exp.duration || 0) / 60000)}m {Math.floor(((exp.duration || 0) % 60000) / 1000)}s
                                                            </td>
                                                            <td className="px-6 py-4 text-sm text-gray-600">
                                                                {exp.startTime ? new Date(exp.startTime).toLocaleDateString() : 'N/A'}
                                                            </td>
                                                            <td className="px-6 py-4 text-right space-x-2">
                                                                <button
                                                                    onClick={() => {
                                                                        setSelectedExperiment(exp);
                                                                        setView('detail');
                                                                    }}
                                                                    className="text-blue-600 hover:text-blue-800 font-medium text-sm"
                                                                >
                                                                    View
                                                                </button>
                                                                <button
                                                                    onClick={() => exportCSV(exp)}
                                                                    className="text-green-600 hover:text-green-800 font-medium text-sm"
                                                                >
                                                                    Export
                                                                </button>
                                                                <button
                                                                    onClick={() => deleteExperiment(exp.sessionId)}
                                                                    className="text-red-600 hover:text-red-800 font-medium text-sm"
                                                                >
                                                                    Delete
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // Detail view
            if (view === 'detail' && selectedExperiment) {
                const stats = calculateStats(selectedExperiment);

                return (
                    <div className="min-h-screen bg-gray-50">
                        {/* Header */}
                        <div className="bg-white shadow-md">
                            <div className="max-w-7xl mx-auto px-6 py-6">
                                <button
                                    onClick={() => setView('list')}
                                    className="text-blue-600 hover:text-blue-800 mb-4"
                                >
                                    ← Back to List
                                </button>
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h1 className="text-3xl font-bold text-gray-900">
                                            Participant {selectedExperiment.participantId}
                                        </h1>
                                        <p className="text-gray-600 mt-1">
                                            Session: {selectedExperiment.sessionId}
                                        </p>
                                    </div>
                                    <button
                                        onClick={() => exportCSV(selectedExperiment)}
                                        className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        <DownloadIcon />
                                        <span>Export CSV</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="max-w-7xl mx-auto px-6 py-6">
                            {/* Key Metrics */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                <div className="bg-white rounded-lg shadow-md p-6">
                                    <p className="text-sm text-gray-600">Condition</p>
                                    <p className="text-2xl font-bold text-gray-900 mt-1">
                                        {selectedExperiment.condition === 'with_llm' ? 'With LLM' : 'Without LLM'}
                                    </p>
                                </div>
                                <div className="bg-white rounded-lg shadow-md p-6">
                                    <p className="text-sm text-gray-600">Total Events</p>
                                    <p className="text-2xl font-bold text-blue-600 mt-1">{stats.totalEvents}</p>
                                </div>
                                <div className="bg-white rounded-lg shadow-md p-6">
                                    <p className="text-sm text-gray-600">Duration</p>
                                    <p className="text-2xl font-bold text-purple-600 mt-1">
                                        {Math.floor(selectedExperiment.duration / 60000)}m {Math.floor((selectedExperiment.duration % 60000) / 1000)}s
                                    </p>
                                </div>
                                <div className="bg-white rounded-lg shadow-md p-6">
                                    <p className="text-sm text-gray-600">Avg Event Interval</p>
                                    <p className="text-2xl font-bold text-green-600 mt-1">{stats.averageEventInterval}s</p>
                                </div>
                            </div>

                            {/* Interaction Classification */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                <div className="bg-white rounded-lg shadow-md p-6">
                                    <h3 className="text-lg font-bold mb-4">Interaction Classification</h3>
                                    <canvas id="classificationChart"></canvas>
                                </div>

                                <div className="bg-white rounded-lg shadow-md p-6">
                                    <h3 className="text-lg font-bold mb-4">Interaction Types</h3>
                                    <div className="space-y-3">
                                        <div className="flex items-center justify-between p-3 bg-blue-50 rounded">
                                            <span className="font-medium">Reading Events</span>
                                            <span className="text-xl font-bold text-blue-600">
                                                {stats.reading} ({stats.readingPercentage}%)
                                            </span>
                                        </div>
                                        <div className="flex items-center justify-between p-3 bg-green-50 rounded">
                                            <span className="font-medium">Scanning Events</span>
                                            <span className="text-xl font-bold text-green-600">
                                                {stats.scanning} ({stats.scanningPercentage}%)
                                            </span>
                                        </div>
                                        <div className="flex items-center justify-between p-3 bg-orange-50 rounded">
                                            <span className="font-medium">Scrolling Events</span>
                                            <span className="text-xl font-bold text-orange-600">
                                                {stats.scrolling} ({stats.scrollingPercentage}%)
                                            </span>
                                        </div>
                                        <div className="mt-4 p-4 bg-gray-50 rounded border-t-2 border-gray-200">
                                            <p className="text-sm font-semibold text-gray-700 mb-2">Time-Based Analysis</p>
                                            <div className="space-y-1 text-sm">
                                                <div className="flex justify-between">
                                                    <span className="text-gray-600">Reading (pause only):</span>
                                                    <span className="font-semibold text-blue-600">{stats.readingTime}s ({stats.readingTimePercentage}%)</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-600">Scanning (pause only):</span>
                                                    <span className="font-semibold text-green-600">{stats.scanningTime}s ({stats.scanningTimePercentage}%)</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-600">Scrolling (all motion):</span>
                                                    <span className="font-semibold text-orange-600">{stats.scrollingTime}s ({stats.scrollingTimePercentage}%)</span>
                                                </div>
                                                <div className="flex justify-between pt-2 border-t border-gray-300">
                                                    <span className="text-gray-700 font-medium">Total Reading Session:</span>
                                                    <span className="font-bold text-gray-900">{stats.totalReadingTime}s ({(stats.totalReadingTime/60).toFixed(1)}m)</span>
                                                </div>
                                            </div>
                                            <div className="mt-3 pt-2 border-t border-gray-200 text-xs text-gray-500">
                                                <div>• Reading/Scanning = pause time when stopped</div>
                                                <div>• Scrolling = all actual scroll motion time</div>
                                                <div>• Total = Reading + Scanning + Scrolling = 100%</div>
                                            </div>
                                        </div>
                                        {selectedExperiment.condition === 'with_llm' && (
                                            <div className="flex items-center justify-between p-3 bg-purple-50 rounded mt-3">
                                                <span className="font-medium">LLM Queries</span>
                                                <span className="text-xl font-bold text-purple-600">
                                                    {stats.llmQueries}
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Time by Section */}
                            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                                <h3 className="text-lg font-bold mb-4">Time Spent by Section</h3>
                                <canvas id="sectionTimeChart"></canvas>
                            </div>

                            {/* Reading Session Timeline */}
                            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                                <h3 className="text-lg font-bold mb-4">Reading Session Timeline</h3>
                                <div className="overflow-x-auto">
                                    {(() => {
                                        const scrollEvents = selectedExperiment.events.filter(e => e.eventType === 'scroll_pause');
                                        if (scrollEvents.length === 0) {
                                            return <p className="text-gray-500">No scroll events recorded</p>;
                                        }
                                        
                                        const startTime = selectedExperiment.events.find(e => e.eventType === 'reading_phase_start')?.timestamp || scrollEvents[0].timestamp;
                                        const endTime = selectedExperiment.events.find(e => e.eventType === 'reading_phase_complete')?.timestamp || scrollEvents[scrollEvents.length - 1].timestamp;
                                        const totalDuration = endTime - startTime;
                                        
                                        return (
                                            <div>
                                                <div className="mb-4 text-sm text-gray-600">
                                                    <span>Session: {new Date(startTime).toLocaleTimeString()} - {new Date(endTime).toLocaleTimeString()}</span>
                                                    <span className="ml-4">Duration: {(totalDuration / 1000 / 60).toFixed(1)} minutes</span>
                                                    <span className="ml-4">Events: {scrollEvents.length}</span>
                                                </div>
                                                
                                                <div className="relative bg-gray-50 rounded-lg border border-gray-300 p-4" style={{minHeight: '200px'}}>
                                                    {/* Base timeline */}
                                                    <div className="absolute bottom-12 left-8 right-8 h-2 bg-gray-300 rounded"></div>
                                                    
                                                    {/* Time markers */}
                                                    {[0, 0.25, 0.5, 0.75, 1].map(fraction => (
                                                        <div key={fraction} className="absolute bottom-12" style={{left: `${8 + fraction * 84}%`}}>
                                                            <div className="w-px h-4 bg-gray-500 -mb-4"></div>
                                                            <div className="text-xs text-gray-600 mt-1 -ml-8 text-center w-16">
                                                                {((fraction * totalDuration) / 1000 / 60).toFixed(1)}m
                                                            </div>
                                                        </div>
                                                    ))}
                                                    
                                                    {/* Events with segments */}
                                                    {scrollEvents.map((event, idx) => {
                                                        const eventTime = event.timestamp - startTime;
                                                        const eventPosition = (eventTime / totalDuration) * 84 + 8; // 8% margin
                                                        
                                                        const pauseDur = event.pauseDuration || 0;
                                                        const scrollDur = event.scrollDuration || 0;
                                                        const totalDur = pauseDur + scrollDur;
                                                        
                                                        // Calculate segment positions (going backwards from event point)
                                                        const pauseStartTime = eventTime - totalDur;
                                                        const scrollStartTime = eventTime - scrollDur;
                                                        
                                                        const pauseStartPos = Math.max(8, (pauseStartTime / totalDuration) * 84 + 8);
                                                        const scrollStartPos = Math.max(8, (scrollStartTime / totalDuration) * 84 + 8);
                                                        
                                                        const colorMap = {
                                                            'reading': '#3B82F6',
                                                            'scanning': '#10B981',
                                                            'scrolling': '#F59E0B'
                                                        };
                                                        const color = colorMap[event.classification] || '#6B7280';
                                                        
                                                        return (
                                                            <div key={idx}>
                                                                {/* Pause segment (colored) */}
                                                                {pauseDur > 0 && (
                                                                    <div
                                                                        className="absolute bottom-12 h-2 opacity-70 group"
                                                                        style={{
                                                                            left: `${pauseStartPos}%`,
                                                                            width: `${scrollStartPos - pauseStartPos}%`,
                                                                            backgroundColor: color,
                                                                            borderRadius: '2px'
                                                                        }}
                                                                    >
                                                                        <div className="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded whitespace-nowrap z-20">
                                                                            <div><strong>{event.classification} - Pause</strong></div>
                                                                            <div>{(pauseDur / 1000).toFixed(2)}s</div>
                                                                        </div>
                                                                    </div>
                                                                )}
                                                                
                                                                {/* Scroll segment (gray) */}
                                                                {scrollDur > 0 && (
                                                                    <div
                                                                        className="absolute bottom-12 h-2 bg-gray-400 opacity-50 group"
                                                                        style={{
                                                                            left: `${scrollStartPos}%`,
                                                                            width: `${eventPosition - scrollStartPos}%`,
                                                                            borderRadius: '2px'
                                                                        }}
                                                                    >
                                                                        <div className="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded whitespace-nowrap z-20">
                                                                            <div><strong>Scroll Motion</strong></div>
                                                                            <div>{(scrollDur / 1000).toFixed(2)}s</div>
                                                                        </div>
                                                                    </div>
                                                                )}
                                                                
                                                                {/* Event dot */}
                                                                <div
                                                                    className="absolute bottom-12 group cursor-pointer"
                                                                    style={{
                                                                        left: `${eventPosition}%`,
                                                                        transform: 'translate(-50%, -50%)'
                                                                    }}
                                                                >
                                                                    <div 
                                                                        className="w-4 h-4 rounded-full border-2 border-white shadow-lg"
                                                                        style={{backgroundColor: color}}
                                                                    ></div>
                                                                    
                                                                    {/* Event number */}
                                                                    <div className="absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-bold text-gray-600">
                                                                        #{idx + 1}
                                                                    </div>
                                                                    
                                                                    {/* Detailed tooltip */}
                                                                    <div className="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-8 px-4 py-3 bg-gray-900 text-white text-xs rounded whitespace-nowrap z-30 shadow-xl">
                                                                        <div className="font-bold text-sm mb-2">Event #{idx + 1}</div>
                                                                        <div className="space-y-1">
                                                                            <div><strong>Classification:</strong> {event.classification}</div>
                                                                            <div><strong>Time:</strong> {new Date(event.timestamp).toLocaleTimeString()}</div>
                                                                            <div><strong>Section:</strong> {event.currentSection}</div>
                                                                            <div className="border-t border-gray-600 my-1 pt-1">
                                                                                <div><strong>Pause Duration:</strong> {(pauseDur / 1000).toFixed(2)}s</div>
                                                                                <div><strong>Scroll Duration:</strong> {(scrollDur / 1000).toFixed(2)}s</div>
                                                                                <div><strong>Total:</strong> {(totalDur / 1000).toFixed(2)}s</div>
                                                                            </div>
                                                                            <div className="text-gray-400 text-xs">
                                                                                Relative time: {(eventTime / 1000).toFixed(1)}s from start
                                                                            </div>
                                                                        </div>
                                                                        <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                
                                                {/* Legend */}
                                                <div className="mt-6 space-y-2">
                                                    <div className="flex items-center space-x-8 text-sm">
                                                        <div className="flex items-center space-x-2">
                                                            <div className="w-8 h-3 bg-blue-600 rounded opacity-70"></div>
                                                            <span>Reading pause (&gt;5s)</span>
                                                        </div>
                                                        <div className="flex items-center space-x-2">
                                                            <div className="w-8 h-3 bg-green-600 rounded opacity-70"></div>
                                                            <span>Scanning pause (2-5s)</span>
                                                        </div>
                                                        <div className="flex items-center space-x-2">
                                                            <div className="w-8 h-3 bg-orange-600 rounded opacity-70"></div>
                                                            <span>Scrolling pause (&lt;2s)</span>
                                                        </div>
                                                        <div className="flex items-center space-x-2">
                                                            <div className="w-8 h-3 bg-gray-400 rounded opacity-50"></div>
                                                            <span>Scroll motion</span>
                                                        </div>
                                                    </div>
                                                    <div className="text-xs text-gray-600">
                                                        • Colored segments = pause time (classification based on this)
                                                        <br/>
                                                        • Gray segments = actual scrolling motion time
                                                        <br/>
                                                        • Dots (#) = event logged at this timestamp
                                                        <br/>
                                                        • Hover over segments or dots for details
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>
                            </div>

                            {/* Event Log */}
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h3 className="text-lg font-bold mb-4">Event Log (Recent 50)</h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-4 py-2 text-left">Time</th>
                                                <th className="px-4 py-2 text-left">Event Type</th>
                                                <th className="px-4 py-2 text-left">Classification</th>
                                                <th className="px-4 py-2 text-left">Section</th>
                                                <th className="px-4 py-2 text-right">Time Since Last (ms)</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {selectedExperiment.events.slice(-50).reverse().map((event, idx) => (
                                                <tr key={idx} className="hover:bg-gray-50">
                                                    <td className="px-4 py-2">
                                                        {new Date(event.timestamp).toLocaleTimeString()}
                                                    </td>
                                                    <td className="px-4 py-2">
                                                        <span className="px-2 py-1 text-xs bg-gray-100 rounded">
                                                            {event.eventType}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-2">
                                                        <span className={`px-2 py-1 text-xs rounded ${
                                                            event.classification === 'reading' ? 'bg-blue-100 text-blue-800' :
                                                            event.classification === 'scanning' ? 'bg-green-100 text-green-800' :
                                                            'bg-orange-100 text-orange-800'
                                                        }`}>
                                                            {event.classification}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-2 text-gray-600">
                                                        {event.currentSection}
                                                    </td>
                                                    <td className="px-4 py-2 text-right text-gray-600">
                                                        {event.timeSinceLast?.toLocaleString()}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        }

        ReactDOM.render(<AdminDashboard />, document.getElementById('root'));
    </script>
</body>
</html>