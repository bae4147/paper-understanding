<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실험 데이터 분석</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, where, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDPd-Fz-PdUwc9uvXAg_xEVR5FyPWCg_zA",
            authDomain: "paper-understanding.firebaseapp.com",
            projectId: "paper-understanding",
            storageBucket: "paper-understanding.firebasestorage.app",
            messagingSenderId: "702665730649",
            appId: "1:702665730649:web:9858bde469085a240fdf48"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.firebaseDb = db;
        window.firebaseCollection = collection;
        window.firebaseGetDocs = getDocs;
        window.firebaseQuery = query;
        window.firebaseWhere = where;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseDoc = doc;
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function Analytics() {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [viewMode, setViewMode] = useState('condition'); // 'condition' or 'paper'
            const [questionData, setQuestionData] = useState({});
            const [regrading, setRegrading] = useState(false);
            const [fixingData, setFixingData] = useState(false);

            useEffect(() => {
                loadData();
                loadQuestionData();
            }, []);

            const loadData = async () => {
                try {
                    setLoading(true);
                    const usersRef = window.firebaseCollection(window.firebaseDb, 'users');
                    const snapshot = await window.firebaseGetDocs(usersRef);

                    const allData = [];

                    for (const userDoc of snapshot.docs) {
                        const participantId = userDoc.id;
                        const userData = userDoc.data();

                        // experiments 서브컬렉션 읽기
                        const experimentsRef = window.firebaseCollection(userDoc.ref, 'experiments');
                        const experimentsSnapshot = await window.firebaseGetDocs(experimentsRef);

                        experimentsSnapshot.forEach((expDoc) => {
                            const expData = expDoc.data();
                            const sessionNumber = expData.sessionNumber;

                            // preSurvey는 첫 세션만 users 문서에 저장됨
                            // postSurvey는 세션별로 저장됨
                            const preSurvey = sessionNumber === 1 ? userData.preSurvey : null;
                            const postSurvey = userData[`postSurvey_session${sessionNumber}`];

                            allData.push({
                                id: expDoc.id,
                                participantId,
                                sessionNumber,
                                preSurvey,
                                postSurvey,
                                quizAnswers: expData.quiz,
                                condition: expData.condition,
                                paperId: expData.paper,
                                timestamp: expData.timestamp,
                                accuracy: expData.accuracy
                            });
                        });
                    }

                    setData(allData);
                } catch (error) {
                    console.error('데이터 로딩 오류:', error);
                    alert('데이터를 불러오는 중 오류가 발생했습니다.');
                } finally {
                    setLoading(false);
                }
            };

            // P### 형태의 참가자 ID만 필터링 (예: P001, P002, P003...)
            const filteredData = data.filter(item => {
                if (!item.participantId) return false;
                // P로 시작하고 그 뒤에 정확히 3자리 숫자가 오는 패턴만 매칭
                return /^P\d{3}$/.test(item.participantId);
            });

            // 컨디션별 통계
            const getConditionStats = () => {
                const stats = {};

                filteredData.forEach(item => {
                    const condition = item.condition || 'unknown';
                    if (!stats[condition]) {
                        stats[condition] = {
                            count: 0,
                            preSurvey: [],
                            postSurvey: [],
                            quizScores: []
                        };
                    }

                    stats[condition].count++;

                    // Pre-survey 데이터
                    if (item.preSurvey) {
                        stats[condition].preSurvey.push(item.preSurvey);
                    }

                    // Post-survey 데이터
                    if (item.postSurvey) {
                        stats[condition].postSurvey.push(item.postSurvey);
                    }

                    // Quiz 점수 계산
                    if (item.quizAnswers) {
                        const score = calculateQuizScore(item.quizAnswers, item.paperId);
                        stats[condition].quizScores.push(score);
                    }
                });

                return stats;
            };

            // 논문별 통계
            const getPaperStats = () => {
                const stats = {};

                filteredData.forEach(item => {
                    const paper = item.paperId || 'unknown';
                    if (!stats[paper]) {
                        stats[paper] = {
                            count: 0,
                            preSurvey: [],
                            postSurvey: [],
                            quizScores: []
                        };
                    }

                    stats[paper].count++;

                    if (item.preSurvey) {
                        stats[paper].preSurvey.push(item.preSurvey);
                    }

                    if (item.postSurvey) {
                        stats[paper].postSurvey.push(item.postSurvey);
                    }

                    if (item.quizAnswers) {
                        const score = calculateQuizScore(item.quizAnswers, item.paperId);
                        stats[paper].quizScores.push(score);
                    }
                });

                return stats;
            };

            // 정답 데이터 로드
            const loadQuestionData = async () => {
                try {
                    const papers = [
                        'chi2023-gan-mood-board',
                        'chi2023-farmers-sensors',
                        'chi2025-lbw-02',
                        'chi2025-lbw-03'
                    ];

                    const loadedData = {};
                    for (const paperId of papers) {
                        const response = await fetch(`questions_data/${paperId}.json`);
                        if (response.ok) {
                            const data = await response.json();
                            loadedData[paperId] = data;
                        }
                    }
                    setQuestionData(loadedData);
                } catch (error) {
                    console.error('정답 데이터 로딩 오류:', error);
                }
            };

            // Quiz 점수 계산 (정답과 비교)
            const calculateQuizScore = (answers, paperId) => {
                if (!answers || !questionData[paperId]) return 0;

                const questions = questionData[paperId].questions;
                let correct = 0;
                let total = 0;

                questions.forEach(q => {
                    const userAnswer = answers[q.id];
                    if (userAnswer !== undefined) {
                        total++;
                        if (userAnswer === q.correctAnswer) {
                            correct++;
                        }
                    }
                });

                return total > 0 ? (correct / total) * 100 : 0;
            };

            // 모든 참가자의 quiz 데이터 구조 수정 (quiz.answers -> quiz)
            const fixP004QuizData = async () => {
                if (!confirm('모든 P### 참가자의 quiz 데이터 구조를 수정하시겠습니까?\n(quiz.answers -> quiz로 변경)')) {
                    return;
                }

                setFixingData(true);
                try {
                    const usersRef = window.firebaseCollection(window.firebaseDb, 'users');
                    const snapshot = await window.firebaseGetDocs(usersRef);

                    let fixedCount = 0;
                    let skippedCount = 0;

                    for (const userDoc of snapshot.docs) {
                        const participantId = userDoc.id;

                        // P### 형태만 처리
                        if (!/^P\d{3}$/.test(participantId)) {
                            continue;
                        }

                        const experimentsRef = window.firebaseCollection(userDoc.ref, 'experiments');
                        const experimentsSnapshot = await window.firebaseGetDocs(experimentsRef);

                        for (const expDoc of experimentsSnapshot.docs) {
                            const expData = expDoc.data();

                            // quiz.answers 구조인 경우 수정
                            if (expData.quiz && expData.quiz.answers && typeof expData.quiz.answers === 'object') {
                                const fixedQuiz = expData.quiz.answers;

                                const expDocRef = window.firebaseDoc(
                                    window.firebaseDb,
                                    'users',
                                    participantId,
                                    'experiments',
                                    expDoc.id
                                );

                                await window.firebaseUpdateDoc(expDocRef, {
                                    quiz: fixedQuiz
                                });

                                fixedCount++;
                                console.log(`✅ ${participantId} - ${expDoc.id} 수정 완료: quiz.answers -> quiz`);
                            } else {
                                skippedCount++;
                                console.log(`✓ ${participantId} - ${expDoc.id} 스킵 (이미 올바른 구조)`);
                            }
                        }
                    }

                    alert(`Quiz 데이터 구조 수정 완료!\n수정: ${fixedCount}개\n스킵: ${skippedCount}개`);

                    // 데이터 새로고침
                    await loadData();
                } catch (error) {
                    console.error('Quiz 데이터 수정 오류:', error);
                    alert('데이터 수정 중 오류가 발생했습니다.');
                } finally {
                    setFixingData(false);
                }
            };

            // 퀴즈 재채점 및 Firebase 업데이트
            const regradeAllQuizzes = async () => {
                if (!confirm('모든 참가자의 퀴즈를 재채점하고 accuracy를 Firebase에 저장하시겠습니까?')) {
                    return;
                }

                setRegrading(true);
                try {
                    const usersRef = window.firebaseCollection(window.firebaseDb, 'users');
                    const snapshot = await window.firebaseGetDocs(usersRef);

                    let processedCount = 0;
                    let errorCount = 0;

                    for (const userDoc of snapshot.docs) {
                        const participantId = userDoc.id;

                        // P### 형태만 처리
                        if (!/^P\d{3}$/.test(participantId)) {
                            continue;
                        }

                        // experiments 서브컬렉션 읽기
                        const experimentsRef = window.firebaseCollection(userDoc.ref, 'experiments');
                        const experimentsSnapshot = await window.firebaseGetDocs(experimentsRef);

                        for (const expDoc of experimentsSnapshot.docs) {
                            const expData = expDoc.data();

                            if (expData.quiz && expData.paper) {
                                const accuracy = calculateQuizScore(expData.quiz, expData.paper);
                                const roundedAccuracy = parseFloat(accuracy.toFixed(2));

                                // accuracy가 변경되었거나 없으면 업데이트
                                if (expData.accuracy !== roundedAccuracy) {
                                    try {
                                        const expDocRef = window.firebaseDoc(
                                            window.firebaseDb,
                                            'users',
                                            participantId,
                                            'experiments',
                                            expDoc.id
                                        );
                                        await window.firebaseUpdateDoc(expDocRef, {
                                            accuracy: roundedAccuracy
                                        });
                                        processedCount++;
                                        console.log(`✓ ${participantId} - ${expDoc.id} 재채점 완료: ${roundedAccuracy}%`);
                                    } catch (error) {
                                        console.error(`✗ ${participantId} - ${expDoc.id} 업데이트 실패:`, error);
                                        errorCount++;
                                    }
                                }
                            }
                        }
                    }

                    alert(`재채점 완료!\n처리: ${processedCount}개 세션\n오류: ${errorCount}개`);

                    // 데이터 새로고침
                    await loadData();
                } catch (error) {
                    console.error('재채점 오류:', error);
                    alert('재채점 중 오류가 발생했습니다.');
                } finally {
                    setRegrading(false);
                }
            };

            const stats = viewMode === 'condition' ? getConditionStats() : getPaperStats();

            const calculateAverage = (scores) => {
                if (scores.length === 0) return 0;
                return (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-xl">데이터 로딩 중...</div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 p-8">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h1 className="text-3xl font-bold mb-6">실험 데이터 분석</h1>

                            {/* 뷰 옵션 */}
                            <div className="flex gap-4 mb-6">
                                <div>
                                    <label className="block text-sm font-medium mb-2">분석 기준</label>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => setViewMode('condition')}
                                            className={`px-4 py-2 rounded ${
                                                viewMode === 'condition'
                                                    ? 'bg-blue-600 text-white'
                                                    : 'bg-gray-200 text-gray-700'
                                            }`}
                                        >
                                            컨디션별
                                        </button>
                                        <button
                                            onClick={() => setViewMode('paper')}
                                            className={`px-4 py-2 rounded ${
                                                viewMode === 'paper'
                                                    ? 'bg-blue-600 text-white'
                                                    : 'bg-gray-200 text-gray-700'
                                            }`}
                                        >
                                            논문별
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-blue-50 border-l-4 border-blue-600 p-4 mb-6">
                                <p className="text-sm">
                                    <strong>총 데이터:</strong> {data.length}개 |{' '}
                                    <strong>P### 형태 참가자:</strong> {filteredData.length}개
                                </p>
                            </div>
                        </div>

                        {/* 통계 카드 */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {Object.entries(stats).map(([key, value]) => (
                                <div key={key} className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-xl font-bold mb-4 text-blue-600">
                                        {viewMode === 'condition' ? `컨디션: ${key}` : `논문: ${key}`}
                                    </h2>

                                    <div className="space-y-3">
                                        <div className="border-b pb-2">
                                            <p className="text-sm text-gray-600">참가자 수</p>
                                            <p className="text-2xl font-bold">{value.count}</p>
                                        </div>

                                        <div className="border-b pb-2">
                                            <p className="text-sm text-gray-600">퀴즈 평균 점수</p>
                                            <p className="text-2xl font-bold">
                                                {calculateAverage(value.quizScores)}
                                            </p>
                                            <p className="text-xs text-gray-500">
                                                (응답 {value.quizScores.length}개)
                                            </p>
                                        </div>

                                        <div className="border-b pb-2">
                                            <p className="text-sm text-gray-600">Pre-Survey 응답</p>
                                            <p className="text-xl font-semibold">{value.preSurvey.length}개</p>
                                        </div>

                                        <div>
                                            <p className="text-sm text-gray-600">Post-Survey 응답</p>
                                            <p className="text-xl font-semibold">{value.postSurvey.length}개</p>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* 상세 데이터 테이블 */}
                        <div className="bg-white rounded-lg shadow-lg p-6 mt-6">
                            <h2 className="text-2xl font-bold mb-4">상세 데이터</h2>
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th className="px-4 py-2 text-left">참가자 ID</th>
                                            <th className="px-4 py-2 text-left">세션</th>
                                            <th className="px-4 py-2 text-left">컨디션</th>
                                            <th className="px-4 py-2 text-left">논문</th>
                                            <th className="px-4 py-2 text-left">Pre-Survey</th>
                                            <th className="px-4 py-2 text-left">Post-Survey</th>
                                            <th className="px-4 py-2 text-left">Quiz 답변</th>
                                            <th className="px-4 py-2 text-left">Accuracy</th>
                                            <th className="px-4 py-2 text-left">제출 시간</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredData.map((item, index) => {
                                            const accuracy = item.quizAnswers ? calculateQuizScore(item.quizAnswers, item.paperId) : null;
                                            return (
                                                <tr key={item.id} className={index % 2 === 0 ? 'bg-gray-50' : ''}>
                                                    <td className="px-4 py-2 font-medium">{item.participantId}</td>
                                                    <td className="px-4 py-2">{item.sessionNumber || '-'}</td>
                                                    <td className="px-4 py-2">{item.condition || '-'}</td>
                                                    <td className="px-4 py-2 text-sm">{item.paperId || '-'}</td>
                                                    <td className="px-4 py-2">
                                                        {item.preSurvey ? '✓' : '-'}
                                                    </td>
                                                    <td className="px-4 py-2">
                                                        {item.postSurvey ? '✓' : '-'}
                                                    </td>
                                                    <td className="px-4 py-2">
                                                        {item.quizAnswers ?
                                                            `${Object.keys(item.quizAnswers).length}개` : '-'}
                                                    </td>
                                                    <td className="px-4 py-2">
                                                        {accuracy !== null ? (
                                                            <span className={accuracy >= 70 ? 'text-green-600 font-semibold' : accuracy >= 50 ? 'text-yellow-600' : 'text-red-600'}>
                                                                {accuracy.toFixed(1)}%
                                                            </span>
                                                        ) : '-'}
                                                    </td>
                                                    <td className="px-4 py-2 text-sm">
                                                        {item.timestamp ?
                                                            new Date(item.timestamp.seconds * 1000).toLocaleString('ko-KR')
                                                            : '-'}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* 버튼들 */}
                        <div className="mt-6 text-center flex gap-4 justify-center flex-wrap">
                            <button
                                onClick={loadData}
                                className="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700"
                                disabled={loading}
                            >
                                데이터 새로고침
                            </button>
                            <button
                                onClick={fixP004QuizData}
                                className="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 disabled:bg-gray-400"
                                disabled={fixingData || loading}
                            >
                                {fixingData ? '수정 중...' : 'Quiz 구조 수정 (모든 P###)'}
                            </button>
                            <button
                                onClick={regradeAllQuizzes}
                                className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400"
                                disabled={regrading || loading || Object.keys(questionData).length === 0}
                            >
                                {regrading ? '재채점 중...' : '퀴즈 재채점 (Accuracy 업데이트)'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<Analytics />, document.getElementById('root'));
    </script>
</body>
</html>
